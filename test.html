<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мир и Конфликты</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    /* Убираем отступы у body и делаем карту на весь экран */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    .joystick {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    #map {
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    .js {
      padding: 15px;
      border-style: none;
      border-radius: 100px;
      background-color: white;
      line-height: 10px;
    }
    /* Стили для пульсирующей точки */
    .pulse-icon {
      border-radius: 50%;
      width: 14px;
      height: 14px;
      background: red;
      position: relative;
    }
    
    .pulse-icon:before {
      content: '';
      border-radius: 50%;
      height: 300%;
      width: 300%;
      position: absolute;
      top: -100%;
      left: -100%;
      background: rgba(255, 0, 0, 0.4);
      animation: pulse 2s infinite ease-out;
    }
    
    .pulse-icon:after {
      content: '';
      border-radius: 50%;
      height: 300%;
      width: 300%;
      position: absolute;
      top: -100%;
      left: -100%;
      background: rgba(255, 0, 0, 0.2);
      animation: pulse 2s infinite ease-out;
      animation-delay: 0.5s;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.1);
        opacity: 1;
      }
      70% {
        transform: scale(2);
        opacity: 0.3;
      }
      100% {
        transform: scale(3);
        opacity: 0;
      }
    }
    
    .marker-container {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="joystick">
    <div class="row">
        <button class="js" onclick="pan(0, -100)">↑</button>
    </div>
    <div class="row">
        <button class="js" onclick="pan(-100, 0)">←</button>
        <button class="js" onclick="pan(100, 0)">→</button>
    </div>
    <div class="row">
        <button class="js" onclick="pan(0, 100)">↓</button>
    </div>
</div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Инициализация карты с deferred рендерингом
    var map = L.map('map', {
      center: [15.4542, 18.7322],
      zoom: 3,
      // maxBounds: [[-50, -180], [1, 180]],
      maxBoundsViscosity: 1.0,
      // Включаем deferred рендеринг
      preferCanvas: true, // Используем canvas для рендеринга (улучшает производительность)
      // zoomAnimation: true,
      // fadeAnimation: true,
      // markerZoomAnimation: true
    });
    map.invalidateSize();
    // Добавление OpenStreetMap слоя с deferred загрузкой
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      // Оптимизация загрузки тайлов
      tileSize: 256,
      updateWhenIdle: true, // Загрузка тайлов только после завершения движения карты
      updateWhenZooming: false // Отключение загрузки тайлов во время зума
    }).addTo(map);

    // Функция для создания пульсирующего маркера
    function createPulsingMarker(lat, lng, popupContent) {
      var markerHtml = '<div class="marker-container"><div class="pulse-icon"></div></div>';
      
      var pulsingIcon = L.divIcon({
        html: markerHtml,
        className: '',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      
      var marker = L.marker([lat, lng], {
        icon: pulsingIcon
      }).addTo(map);
      
      marker.bindPopup(popupContent);
      
      return marker;
    }
    
    // Список маркеров
    var markers = [
      { lat: 50.0, lng: 30.0, popup: '<b>Конфликт в Киеве, Украина</b><br>Здесь происходит военное событие.' },
      { lat: 34.0522, lng: -118.2437, popup: '<b>Конфликт в Лос-Анджелесе, США</b><br>Здесь происходит военное событие.' },
      { lat: 40.7128, lng: -74.0060, popup: '<b>Конфликт в Нью-Йорке, США</b><br>Здесь происходит военное событие.' },
      { lat: -34.6037, lng: -58.3816, popup: '<b>Конфликт в Буэнос-Айресе, Аргентина</b><br>Здесь происходит военное событие.' }
    ];
    
    // Добавление маркеров на карту
    markers.forEach(function(marker) {
      createPulsingMarker(marker.lat, marker.lng, marker.popup);
    });
    function pan(x, y) {
        map.panBy([x, y]); // сдвигает карту на x и y пикселей
    }
    // Оптимизация производительности при масштабировании
    map.on('zoomend', function() {
      map.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
          layer._icon.style.transition = 'transform 0.3s';
        }
      });
    });
  </script>
</body>
</html>